#!/bin/bash

show_help() {
  cat <<EOF
todo-scripts: Update Task Due Date

USAGE:
  rt <task_line_number> <proposed_due_date>

DESCRIPTION:
  Updates the due date of a task in your todo.txt file by line number.

ARGUMENTS:
  <task_line_number>   The line number of the task to update (1-based)
  <proposed_due_date>  The new due date in YYYY-MM-DD format

OPTIONS:
  -h, --help           Show this help message

EXAMPLES:
  rt 3 2025-09-15      # Change due date of task on line 3 to 2025-09-15

FILES:
  todo.txt             Task file (must exist in current directory)

SEE ALSO:
  add(1)   - Add a new task
  td(1)    - Display task dashboard
  ar(1)    - Archive completed tasks

For more information, visit: https://github.com/adityajoshi/todo-scripts
EOF
}

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
  show_help
  exit 0
fi

if [[ $# -ne 2 ]]; then
  echo "Usage: $0 <task_line_number> <proposed_due_date>"
  exit 1
fi

TASK_LINE="$1"
PROP_DUE_DATE="$2"

# Validate date format (YYYY-MM-DD)
validate_date() {
  local date="$1"
  if [[ ! "$date" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
    echo "❌ Error: Invalid date format '$date'. Use YYYY-MM-DD."
    exit 1
  fi
  # Check if date is valid
  if ! date -d "$date" >/dev/null 2>&1 && ! date -j -f "%Y-%m-%d" "$date" >/dev/null 2>&1; then
    echo "❌ Error: Invalid date '$date'."
    exit 1
  fi
}

validate_date "$PROP_DUE_DATE"

# Check if TODO_FILE exists
if [[ ! -f "$TODO_FILE" ]]; then
  echo "❌ Error: $TODO_FILE not found."
  exit 1
fi

# Check if TASK_LINE is a valid number and line exists
if ! [[ "$TASK_LINE" =~ ^[0-9]+$ ]] || ! sed -n "${TASK_LINE}p" "$TODO_FILE" >/dev/null; then
  echo "❌ Error: Invalid task line number: $TASK_LINE"
  exit 1
fi

# Extract current due date from the specified line
CURR_DUE_DATE=$(sed -n "${TASK_LINE}p" "$TODO_FILE" | grep -o 'due:[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}' | cut -d: -f2)

if [[ -z "$CURR_DUE_DATE" ]]; then
  echo "❌ Error: No due date found in line $TASK_LINE"
  exit 1
fi

validate_date "$CURR_DUE_DATE"

# Replace due date
sed -i "${TASK_LINE}s/due:$CURR_DUE_DATE/due:$PROP_DUE_DATE/g" "$TODO_FILE"
echo "✅ Updated due date on line $TASK_LINE: $CURR_DUE_DATE -> $PROP_DUE_DATE"